<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Vending Machine</title>
  <style>
    body {
      font-family: 'Georgia', serif; /* Elegant serif font */
      text-align: center;
      margin: 0;
      background: linear-gradient(135deg, #1a1a2e, #16213e); /* Dark gradient */
      background-size: cover;
      min-height: 100vh;
      color: #e0e0e0;
      position: relative;
      overflow-x: hidden;
    }
    body::before {
      content: '';
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 500px; /* Increased size for better fit */
      height: 500px; /* Increased size for better fit */
      background: url('https://faculty.cutm.ac.in/index_files/cutm-logo.png') no-repeat center;
      background-size: contain;
      opacity: 0.12; /* Slightly increased opacity for visibility */
      z-index: -1;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      z-index: 1;
    }
    .header {
      position: relative;
      padding: 15px;
      background: rgba(26, 26, 46, 0.9);
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    }
    .menu-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 28px;
      cursor: pointer;
      color: #fff;
      transition: color 0.3s;
    }
    .menu-btn:hover {
      color: #b0b0ff;
    }
    .menu {
      display: none;
      position: absolute;
      right: 15px;
      background: #22223b;
      border: 1px solid #333;
      border-radius: 5px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }
    .menu.active {
      display: block;
    }
    .menu div {
      padding: 12px 20px;
      cursor: pointer;
      color: #e0e0e0;
      transition: background 0.3s;
    }
    .menu div:hover {
      background: #4a4e69;
    }
    .welcome {
      font-size: 2.8em;
      color: #fff;
      text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.7);
      margin: 20px 0;
      animation: fadeIn 2s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .product {
      display: inline-block;
      margin: 15px;
      border: 2px solid #4a4e69;
      padding: 20px;
      background: rgba(74, 78, 105, 0.9);
      border-radius: 15px;
      width: 220px;
      vertical-align: top;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .product:hover {
      transform: scale(1.07);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
    }
    .product img {
      width: 160px;
      height: 160px;
      object-fit: contain;
      border-radius: 10px;
      border: 2px solid #fff;
    }
    #userSection {
      display: none;
      margin-top: 30px;
    }
    #products, #cart {
      margin: 15px 0;
    }
    #cart {
      background: rgba(74, 78, 105, 0.9);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }
    input, button {
      padding: 12px;
      margin: 8px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      transition: transform 0.2s, background 0.3s;
    }
    .start-btn {
      background: #6a4e9b;
      color: #fff;
      font-size: 1.3em;
      padding: 15px 35px;
      cursor: pointer;
      font-weight: bold;
      text-transform: uppercase;
    }
    .start-btn:hover {
      background: #8a6bb1;
      transform: scale(1.05);
    }
    .select-btn {
      background: #4a90e2;
      color: #fff;
    }
    .select-btn:hover {
      background: #357abd;
      transform: scale(1.05);
    }
    .remove-btn {
      background: #e63946;
      color: #fff;
    }
    .remove-btn:hover {
      background: #c22f3a;
      transform: scale(1.05);
    }
    .admin-panel {
      display: none;
    }
    #inventory, #productForm {
      margin: 15px 0;
    }
    .edit-price-btn {
      background: #f4a261;
      color: #fff;
    }
    .edit-price-btn:hover {
      background: #e07a5f;
      transform: scale(1.05);
    }
    .edit-stock-btn {
      background: #9b59b6;
      color: #fff;
    }
    .edit-stock-btn:hover {
      background: #8e44ad;
      transform: scale(1.05);
    }
    .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(34, 34, 59, 0.95);
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      z-index: 2000;
      color: #fff;
      font-size: 1.1em;
    }
    .popup.active {
      display: block;
      animation: pop 0.5s;
    }
    @keyframes pop {
      from { transform: translate(-50%, -50%) scale(0); }
      to { transform: translate(-50%, -50%) scale(1); }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="menu-btn" onclick="toggleMenu()">â‹®</div>
      <div class="menu" id="menu">
        <div onclick="loginAdmin()">Admin Login</div>
        <div onclick="logoutAdmin()" id="logoutBtn" style="display: none;">Admin Logout</div>
      </div>
      <h1 class="welcome">Welcome to Smart Vending Machine!</h1>
      <button class="start-btn" id="startBtn" onclick="startShopping()">Start Shopping</button>
    </div>
    <div id="userSection">
      <h2>Select Your Items</h2>
      <div id="products"></div>
      <div id="cart">
        <h3>Your Cart</h3>
        <div id="cartItems"></div>
        <p>Total: <span id="totalAmount">0</span> INR</p>
        <p id="paymentStatus"></p>
        <button onclick="processPayment()">Pay with UPI QR</button>
      </div>
    </div>
    <div class="admin-panel" id="adminPanel">
      <h2>ANJALI Admin Panel</h2>
      <div id="inventory"></div>
      <h3>Manage Products</h3>
      <div id="productForm">
        <input type="text" id="productName" placeholder="Product Name" style="background: #333; color: #fff;">
        <input type="number" id="productPrice" placeholder="Price" style="background: #333; color: #fff;">
        <input type="text" id="productChannel" placeholder="Channel (e.g., 01)" style="background: #333; color: #fff;">
        <input type="number" id="productDelay" placeholder="Delay (seconds)" style="background: #333; color: #fff;">
        <input type="text" id="productImage" placeholder="Image URL" style="background: #333; color: #fff;">
        <button onclick="addOrUpdateProduct()">Add/Update Product</button>
      </div>
    </div>
    <div class="popup" id="loginPopup">
      <h3>Admin Login</h3>
      <input type="password" id="adminPassword" placeholder="Enter Password" style="background: #333; color: #fff;" required>
      <button onclick="submitAdminLogin()">Login</button>
      <button onclick="closePopup()">Cancel</button>
    </div>
  </div>

  <script>
    let products = [
      { name: "5 Star", price: 10, channel: "01", delay: 5, image: "https://5.imimg.com/data5/SELLER/Default/2024/4/408908849/RO/RA/SR/218584372/cadbury-5-star-chocolate-1000x1000.jpg", stock: 10 },
      { name: "Jim Jam", price: 10, channel: "02", delay: 5, image: "https://th.bing.com/th/id/OIP.Cb7wCemkaeYg8qzyUSPEbwHaHa?w=196&h=196&c=7&r=0&o=7&dpr=1.3&pid=1.7&rm=3", stock: 10 },
      { name: "Kit Kat", price: 10, channel: "03", delay: 5, image: "https://ruperhat.com/wp-content/uploads/2021/02/Kit-Kat-Chocolate-Bar-36-Un-768x768.jpg", stock: 10 },
      { name: "BourBon", price: 10, channel: "04", delay: 5, image: "https://www.urbangroc.com/wp-content/uploads/2021/04/britannia-bourbon-1-01.jpg", stock: 10 }
    ];
    let cart = [];
    let isAdmin = false;

    function toggleMenu() {
      document.getElementById('menu').classList.toggle('active');
    }

    function loginAdmin() {
      document.getElementById('loginPopup').classList.add('active');
      document.getElementById('menu').classList.remove('active');
    }

    function submitAdminLogin() {
      const password = document.getElementById('adminPassword').value;
      if (password === "admin123") {
        isAdmin = true;
        document.getElementById('userSection').style.display = 'none';
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
        document.getElementById('logoutBtn').style.display = 'block';
        document.getElementById('loginPopup').classList.remove('active');
        document.getElementById('menu').classList.remove('active');
        updateInventory();
      } else {
        alert("Invalid password!");
      }
    }

    function logoutAdmin() {
      isAdmin = false;
      document.getElementById('adminPanel').style.display = 'none';
      document.getElementById('userSection').style.display = 'none';
      document.getElementById('startBtn').style.display = 'block';
      document.getElementById('logoutBtn').style.display = 'none';
      cart = [];
      updateInventory(); // Ensure inventory reflects changes
    }

    function closePopup() {
      document.getElementById('loginPopup').classList.remove('active');
    }

    function startShopping() {
      if (!isAdmin) {
        document.getElementById('userSection').style.display = 'block';
        displayProducts();
        showPopup("Happy Shopping! Enjoy your chocolates!");
      }
    }

    function displayProducts() {
      if (!isAdmin) {
        const productDiv = document.getElementById('products');
        productDiv.innerHTML = '';
        products.forEach(product => {
          if (product.stock > 0) {
            productDiv.innerHTML += `<div class="product">
              <img src="${product.image}" alt="${product.name}" onerror="this.src='https://via.placeholder.com/150';"><br>
              <span style="font-size: 1.1em; font-weight: bold;">${product.name}</span><br>
              <span style="color: #b0b0ff;">Channel: ${product.channel}</span><br>
              <span style="color: #ffd166;">Price: ${product.price} INR</span><br>
              <span style="color: #e63946;">Stock: ${product.stock}</span><br>
              <button class="select-btn" onclick="addToCart('${product.name}', ${product.price}, '${product.channel}')">Select</button>
            </div>`;
          }
        });
      }
    }

    function addToCart(name, price, channel) {
      if (!isAdmin) {
        const product = products.find(p => p.name === name);
        if (product.stock > 0) {
          cart.push({ id: Date.now() + Math.random(), name, price, channel }); // Unique ID for each item
          product.stock--;
          updateCart();
          displayProducts();
          showPopup(`${name} added to cart!`);
        } else {
          showPopup(`${name} is out of stock!`, true);
        }
      }
    }

    function updateCart() {
      if (!isAdmin) {
        const cartItemsDiv = document.getElementById('cartItems');
        cartItemsDiv.innerHTML = '';
        let total = 0;
        cart.forEach(item => {
          cartItemsDiv.innerHTML += `<p><span style="font-weight: bold;">${item.name}</span> (Channel: ${item.channel}) - <span style="color: #ffd166;">${item.price} INR</span> <button class="remove-btn" onclick="removeFromCart('${item.id}')">Remove</button></p>`;
          total += item.price;
        });
        document.getElementById('totalAmount').textContent = total;
      }
    }

    function removeFromCart(id) {
      if (!isAdmin) {
        console.log("Attempting to remove item with id:", id); // Debug log
        const itemIndex = cart.findIndex(item => String(item.id) === id); // Convert id to string for comparison
        if (itemIndex !== -1) {
          console.log("Item found at index:", itemIndex); // Debug log
          const item = cart[itemIndex];
          const product = products.find(p => p.name === item.name);
          product.stock++;
          cart.splice(itemIndex, 1); // Remove only the specific item
          updateCart();
          displayProducts();
          showPopup(`${item.name} removed from cart!`);
        } else {
          console.log("Item with id", id, "not found in cart"); // Debug log
        }
      }
    }

    async function processPayment() {
      if (!isAdmin && cart.length > 0) {
        const total = parseFloat(document.getElementById('totalAmount').textContent);
        const orderId = 'TXN' + Date.now();

        try {
          document.getElementById('paymentStatus').textContent = 'Generating secure UPI QR...';
          const response = await fetch('http://localhost:3000/create-qr', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount: total, orderId }),
          });
          if (!response.ok) throw new Error('Network error');
          const { qr, orderId: razorOrderId } = await response.json();

          // Display QR
          const qrElement = document.createElement('img');
          qrElement.src = qr;
          qrElement.style.width = '200px';
          document.getElementById('paymentStatus').innerHTML = '<p>Scan to pay:</p>';
          document.getElementById('paymentStatus').appendChild(qrElement);
          document.getElementById('paymentStatus').innerHTML += `<p>Amount: ${total} INR (Order: ${razorOrderId})</p>`;

          // Poll for verification (every 5s, up to 2min)
          let attempts = 0;
          const interval = setInterval(async () => {
            attempts++;
            try {
              const verifyRes = await fetch(`http://localhost:3000/verify-payment/${razorOrderId}`);
              const { status } = await verifyRes.json();
              if (status === 'paid') {
                clearInterval(interval);
                document.getElementById('paymentStatus').textContent = 'Payment Successful! Dispensing...';
                cart = []; updateCart(); displayProducts();
                showPopup('Payment confirmed! Enjoy your chocolates!');
              } else if (attempts > 24) { // 2 min timeout
                clearInterval(interval);
                showPopup('Payment timeout. Try again.', true);
              }
            } catch (error) {
              console.error('Verification error:', error);
            }
          }, 5000);
        } catch (error) {
          showPopup('Error generating QR: ' + error.message, true);
        }
      } else {
        document.getElementById('paymentStatus').textContent = 'Cart is empty!';
      }
    }

    function updateInventory() {
      const inventoryDiv = document.getElementById('inventory');
      inventoryDiv.innerHTML = '<h3>Inventory by Channel</h3>';
      products.forEach(product => {
        inventoryDiv.innerHTML += `<div class="product">
          <img src="${product.image}" alt="${product.name}" onerror="this.src='https://via.placeholder.com/150';"><br>
          <span style="font-size: 1.1em; font-weight: bold;">${product.name}</span><br>
          <span style="color: #b0b0ff;">Channel: ${product.channel}</span><br>
          <span style="color: #ffd166;">Price: ${product.price} INR</span><br>
          <span style="color: #e63946;">Stock: ${product.stock}</span><br>
          <button class="edit-price-btn" onclick="editPrice('${product.name}')">Edit Price</button>
          <button class="edit-stock-btn" onclick="editStock('${product.name}')">Edit Stock</button>
          <button class="remove-btn" onclick="removeProduct('${product.name}')">Remove</button>
        </div>`;
      });
    }

    function addOrUpdateProduct() {
      const name = document.getElementById('productName').value;
      const price = parseInt(document.getElementById('productPrice').value);
      const channel = document.getElementById('productChannel').value;
      const delay = parseInt(document.getElementById('productDelay').value);
      const image = document.getElementById('productImage').value;

      if (name && price && channel && delay && image) {
        if (selectedProduct) {
          const product = products.find(p => p.name === selectedProduct);
          product.price = price;
          product.stock = parseInt(prompt(`Enter new stock for ${name}:`, product.stock)) || product.stock;
          selectedProduct = null;
          alert(`${name}'s price updated to ${price} INR and stock to ${product.stock}!`);
        } else {
          products.push({ name, price, channel, delay, image, stock: 10 });
          alert(`${name} added successfully!`);
        }
        clearForm();
        updateInventory();
      }
    }

    function editPrice(name) {
      const product = products.find(p => p.name === name);
      const newPrice = parseInt(prompt(`Enter new price for ${name} (current: ${product.price} INR):`, product.price));
      if (newPrice) {
        product.price = newPrice;
        updateInventory();
        alert(`${name}'s price updated to ${newPrice} INR!`);
      }
    }

    function editStock(name) {
      const product = products.find(p => p.name === name);
      const newStock = parseInt(prompt(`Enter new stock for ${name} (current: ${product.stock}):`, product.stock));
      if (newStock >= 0) {
        product.stock = newStock;
        updateInventory();
        alert(`${name}'s stock updated to ${newStock}!`);
      }
    }

    function removeProduct(name) {
      if (confirm(`Are you sure you want to remove ${name}?`)) {
        products = products.filter(p => p.name !== name);
        clearForm();
        updateInventory();
        alert(`${name} removed successfully!`);
      }
    }

    function clearForm() {
      document.getElementById('productName').value = '';
      document.getElementById('productPrice').value = '';
      document.getElementById('productChannel').value = '';
      document.getElementById('productDelay').value = '';
      document.getElementById('productImage').value = '';
      selectedProduct = null;
    }

    function showPopup(message, isError = false, duration = 2000) {
      if (!isAdmin) {
        const popup = document.createElement('div');
        popup.className = 'popup';
        popup.textContent = message;
        if (isError) popup.style.background = '#e63946';
        document.body.appendChild(popup);
        setTimeout(() => popup.classList.add('active'), 10);
        setTimeout(() => {
          popup.classList.remove('active');
          setTimeout(() => document.body.removeChild(popup), 500);
        }, duration);
      }
    }
  </script>
</body>
</html>